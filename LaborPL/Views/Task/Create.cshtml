@model LaborBLL.ModelVM.CreateTaskViewModel
@using LaborDAL.Enums
@{
    ViewData["Title"] = "Post a Task";
}

<div class="create-task-container fade-in">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary-gradient text-white">
                    <h3 class="mb-0"><i class="bi bi-clipboard-plus me-2"></i>Post a New Task</h3>
                    <p class="mb-0 opacity-75">Describe what you need and find the right worker</p>
                </div>
                <div class="card-body p-4">
                    <form asp-action="Create" method="post" id="createTaskForm">
                        <div asp-validation-summary="All" class="validation-summary-errors"></div>

                        <!-- Basic Info Section -->
                        <div class="form-section mb-4">
                            <h5 class="section-title"><i class="bi bi-info-circle me-2"></i>Basic Information</h5>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label asp-for="Title" class="form-label"></label>
                                    <input asp-for="Title" class="form-control" placeholder="e.g., Need help moving furniture this weekend" />
                                    <span asp-validation-for="Title" class="field-validation-error"></span>
                                </div>
                                <div class="col-12">
                                    <label asp-for="Description" class="form-label"></label>
                                    <textarea asp-for="Description" class="form-control" rows="5" placeholder="Provide detailed description of what needs to be done, including any specific requirements, tools needed, access instructions, etc."></textarea>
                                    <span asp-validation-for="Description" class="field-validation-error"></span>
                                    <div class="form-text">
                                        <span id="charCount">0</span>/5000 characters
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="Category" class="form-label"></label>
                                    <select asp-for="Category" class="form-select" asp-items="Html.GetEnumSelectList<TaskCategory>()">
                                        <option value="">Select a category</option>
                                    </select>
                                    <span asp-validation-for="Category" class="field-validation-error"></span>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="RequiredSkills" class="form-label"></label>
                                    <input asp-for="RequiredSkills" class="form-control" placeholder="e.g., Heavy lifting, Assembly, Electrical" />
                                    <span asp-validation-for="RequiredSkills" class="field-validation-error"></span>
                                    <div class="form-text">Separate skills with commas</div>
                                </div>
                            </div>
                        </div>

                        <!-- Budget Section -->
                        <div class="form-section mb-4">
                            <h5 class="section-title"><i class="bi bi-cash me-2"></i>Budget & Payment</h5>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label asp-for="BudgetType" class="form-label"></label>
                                    <select asp-for="BudgetType" class="form-select" id="budgetType">
                                        @foreach (var item in Html.GetEnumSelectList<BudgetType>())
                                        {
                                            <option value="@item.Value">@item.Text</option>
                                        }
                                    </select>
                                    <span asp-validation-for="BudgetType" class="field-validation-error"></span>
                                </div>
                                <div class="col-md-4">
                                    <label asp-for="Budget" class="form-label"></label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input asp-for="Budget" class="form-control" type="number" step="0.01" placeholder="0.00" />
                                    </div>
                                    <span asp-validation-for="Budget" class="field-validation-error"></span>
                                </div>
                                <div class="col-md-4" id="estimatedHoursField">
                                    <label asp-for="EstimatedHours" class="form-label"></label>
                                    <div class="input-group">
                                        <input asp-for="EstimatedHours" class="form-control" type="number" step="0.5" placeholder="Hours" />
                                        <span class="input-group-text">hrs</span>
                                    </div>
                                    <span asp-validation-for="EstimatedHours" class="field-validation-error"></span>
                                </div>
                            </div>
                            <div class="row g-3 mt-2">
                                <div class="col-md-6">
                                    <label asp-for="WorkersNeeded" class="form-label"></label>
                                    <input asp-for="WorkersNeeded" class="form-control" type="number" min="1" max="100" />
                                    <span asp-validation-for="WorkersNeeded" class="field-validation-error"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Schedule Section -->
                        <div class="form-section mb-4">
                            <h5 class="section-title"><i class="bi bi-calendar me-2"></i>Schedule</h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label asp-for="StartDate" class="form-label"></label>
                                    <input asp-for="StartDate" class="form-control" type="datetime-local" />
                                    <span asp-validation-for="StartDate" class="field-validation-error"></span>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="DueDate" class="form-label"></label>
                                    <input asp-for="DueDate" class="form-control" type="datetime-local" />
                                    <span asp-validation-for="DueDate" class="field-validation-error"></span>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="form-check form-switch">
                                    <input asp-for="IsUrgent" class="form-check-input" type="checkbox" id="urgentSwitch">
                                    <label class="form-check-label" for="urgentSwitch">
                                        <i class="bi bi-lightning-fill text-warning"></i> This is urgent (needs to start within 24 hours)
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Location Section -->
                        <div class="form-section mb-4">
                            <h5 class="section-title"><i class="bi bi-geo-alt me-2"></i>Location</h5>
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input asp-for="IsRemote" class="form-check-input" type="checkbox" id="remoteSwitch">
                                    <label class="form-check-label" for="remoteSwitch">
                                        <i class="bi bi-wifi text-info"></i> This task can be done remotely
                                    </label>
                                </div>
                            </div>
                            <div id="locationFields">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Auto-Detect Location</label>
                                        <button type="button" id="detectLocationBtn" class="btn btn-outline-primary w-100">
                                            <i class="bi bi-crosshair me-1"></i>Detect My Location
                                        </button>
                                        <div id="locationStatus" class="mt-2 small"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Select on Map</label>
                                        <div id="mapPicker" class="map-picker-container"></div>
                                    </div>
                                </div>
                                <div class="row g-3 mt-2">
                                    <div class="col-12">
                                        <label asp-for="Location" class="form-label"></label>
                                        <input asp-for="Location" class="form-control" placeholder="Full address where the task will be performed" />
                                        <span asp-validation-for="Location" class="field-validation-error"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <label asp-for="Country" class="form-label"></label>
                                        <input asp-for="Country" class="form-control" placeholder="Country" />
                                        <span asp-validation-for="Country" class="field-validation-error"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <label asp-for="City" class="form-label"></label>
                                        <input asp-for="City" class="form-control" placeholder="City" />
                                        <span asp-validation-for="City" class="field-validation-error"></span>
                                    </div>
                                </div>
                                <input type="hidden" asp-for="Latitude" id="latitudeInput" />
                                <input type="hidden" asp-for="Longitude" id="longitudeInput" />
                                <input type="hidden" asp-for="LocationUrl" id="locationUrlInput" />
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-flex gap-2 justify-content-between pt-3 border-top">
                            <a asp-action="Index" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle me-1"></i>Cancel
                            </a>
                            <div class="d-flex gap-2">
                                <button type="submit" name="saveAsDraft" value="true" class="btn btn-outline-primary">
                                    <i class="bi bi-save me-1"></i>Save as Draft
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-circle me-1"></i>Post Task
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin="" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    
    <!-- Location Service -->
    <script src="~/js/locationService.js"></script>
    <!-- Map Picker -->
    <script src="~/js/mapPicker.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Character counter for description
            const descriptionField = document.querySelector('textarea[name="Description"]');
            const charCountSpan = document.getElementById('charCount');
            
            descriptionField.addEventListener('input', function() {
                charCountSpan.textContent = this.value.length;
                if (this.value.length > 5000) {
                    charCountSpan.classList.add('text-danger');
                } else {
                    charCountSpan.classList.remove('text-danger');
                }
            });
            
            // Budget type toggle
            const budgetTypeSelect = document.getElementById('budgetType');
            const estimatedHoursField = document.getElementById('estimatedHoursField');
            
            function toggleEstimatedHours() {
                if (budgetTypeSelect.value === '1') { // Hourly
                    estimatedHoursField.style.display = 'block';
                } else {
                    estimatedHoursField.style.display = 'none';
                }
            }
            
            budgetTypeSelect.addEventListener('change', toggleEstimatedHours);
            toggleEstimatedHours(); // Initial state
            
            // Remote toggle
            const remoteSwitch = document.getElementById('remoteSwitch');
            const locationFields = document.getElementById('locationFields');
            
            remoteSwitch.addEventListener('change', function() {
                if (this.checked) {
                    locationFields.style.opacity = '0.5';
                    locationFields.style.pointerEvents = 'none';
                } else {
                    locationFields.style.opacity = '1';
                    locationFields.style.pointerEvents = 'auto';
                }
            });
            
            // Initialize map picker
            let mapPicker = new MapPicker('mapPicker', {
                defaultLat: 30.0444,
                defaultLng: 31.2357,
                defaultZoom: 12,
                onLocationChange: function(data) {
                    document.getElementById('latitudeInput').value = data.latitude;
                    document.getElementById('longitudeInput').value = data.longitude;
                    document.getElementById('locationUrlInput').value = data.locationUrl;
                }
            });
            
            // Auto-detect location
            document.getElementById('detectLocationBtn').addEventListener('click', async function() {
                const btn = this;
                const statusEl = document.getElementById('locationStatus');
                
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Detecting...';
                statusEl.innerHTML = '<span class="text-muted">Getting your location...</span>';
                
                try {
                    if (!LocationService.isGeolocationAvailable()) {
                        throw new Error('Geolocation is not supported by your browser.');
                    }
                    
                    if (!LocationService.isSecureContext()) {
                        throw new Error('Location detection requires HTTPS.');
                    }
                    
                    const position = await LocationService.getCurrentPosition();
                    mapPicker.setLocation(position.latitude, position.longitude);
                    
                    const address = await LocationService.reverseGeocode(position.latitude, position.longitude);
                    
                    if (address.success) {
                        document.querySelector('input[name="Location"]').value = address.address;
                        document.querySelector('input[name="Country"]').value = address.country || '';
                        document.querySelector('input[name="City"]').value = address.city || '';
                    }
                    
                    statusEl.innerHTML = '<span class="text-success"><i class="bi bi-check-circle-fill"></i> Location detected!</span>';
                    
                } catch (error) {
                    statusEl.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-triangle-fill"></i> ${error.message}</span>`;
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-crosshair me-1"></i>Detect My Location';
                }
            });
        });
    </script>
}